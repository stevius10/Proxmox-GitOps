name: ruby
on:
  workflow_dispatch:
<% if @cron && !@cron.empty? %>
  schedule:
    - cron: '<%= @cron %>'
<% end %>

jobs:
  run:
    runs-on: [ "shell" ]
    steps:
      - uses: https://gitea.com/actions/checkout@v4
        with:
          repository: '<%= @org %>/<%= @repo %>'
          ref: 'main'
          path: task

      - uses: https://gitea.com/actions/checkout@v4
        with:
          repository: 'main/libraries'
          ref: 'main'
          path: task/libraries


      - name: diag
        shell: bash -euxo pipefail
        run: |
          pwd
          ls -la
          ls -la task || true
          ls -la task/libraries || true
          find task -maxdepth 2 -type f | sort || true

      - name: run
        working-directory: task
        shell: bash -euxo pipefail
        env:
          ENDPOINT: ${{ vars.ENDPOINT }}
          LOGIN: ${{ vars.LOGIN }}
          PASSWORD: ${{ vars.PASSWORD }}
          RUBYLIB: ${{ github.workspace }}/task/libraries
        run: |
          test -f default.rb
          ruby -v
          ruby default.rb
