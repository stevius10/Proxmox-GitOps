{
  storage file_system <%= @caddy_dir %>
}

(internal) {
  @internal remote_ip 192.168.178.0/24
  @external not remote_ip 192.168.178.0/24
  respond @external "Forbidden" 403
}

(header) {
  header {
    Strict-Transport-Security "max-age=31536000;"
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    Permissions-Policy "interest-cohort=()"
    -Server
  }
}

(common) {
  import header

  log {
    output file <%= @log_dir %>/{args.0}.log {
      roll_size     <%= @logs_roll_size %>
      roll_keep     <%= @logs_roll_keep %>
      roll_keep_for <%= @logs_roll_for %>
    }
  }
}

(default) {
  import common {args.0}

  vars upstream {args.1}

  reverse_proxy {args.1} {
    header_up Host {args.0}
    header_up X-Real-IP {remote_ip}
    header_up X-Forwarded-For {remote_ip}
    header_up X-Container-IP {args.1}
  }
}

<% @hosts.each do |entry| -%> <% domain, upstream, hostname = entry.split(' ') -%>
  <%= domain %> {
    import default <%= hostname %> <%= upstream %>
    import internal

    tls internal

    import <%= @config_dir %>/*<%= hostname %>.caddy
  }
<% end -%>

import <%= @config_dir %>/*.local.caddy
