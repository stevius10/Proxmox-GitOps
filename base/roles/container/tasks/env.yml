- name: Environment
  block:
  - name: Configuration file
    block:
    - name: Get configuration file
      ansible.builtin.stat:
        path: "config.json"
      register: config_file

    - name: Load configuration file
      ansible.builtin.include_vars:
        file: "config.json"
        name: config
      when: config_file.stat.exists

  - name: Proxmox configuration
    block:
    - name: Set Proxmox environment
      ansible.builtin.set_fact:
        PROXMOX_HOST: "{{ lookup('env', 'PROXMOX_HOST') }}"
        PROXMOX_USER: "{{ lookup('env', 'PROXMOX_USER') }}"
        PROXMOX_PASSWORD: "{{ lookup('env', 'PROXMOX_PASSWORD') }}"
        PROXMOX_TOKEN: "{{ lookup('env', 'PROXMOX_TOKEN') }}"
        PROXMOX_SECRET: "{{ lookup('env', 'PROXMOX_SECRET') }}"
      when:
        - (config_file.stat.exists and config.proxmox is defined) or (not config_file.stat.exists)

    - name: Get root ticket
      block:
        - name: Get Proxmox ticket
          uri:
            url: "https://{{ PROXMOX_HOST }}:8006/api2/json/access/ticket"
            method: POST
            body:
              username: "{{ PROXMOX_USER }}"
              password: "{{ PROXMOX_PASSWORD }}"
            body_format: json
            validate_certs: no
          register: proxmox_login
          when: (PROXMOX_PASSWORD | default('')) | trim != ''
