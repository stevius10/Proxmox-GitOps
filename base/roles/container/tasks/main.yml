- name: Environment
  include_tasks: env.yml

- name: Container orchestration
  block:
  - name: Check container
    community.general.proxmox_vm_info:
      vmid: "{{ id }}"
    register: container_exists

  - name: Remove existing container
    include_tasks: remove.yml
    when: (container_exists.proxmox_vms | default([]) | length) > 0

  - name: Create container
    include_tasks: create.yml

  - name: Start container
    include_tasks: start.yml

  - name: Add container
    include_tasks: add.yml

  module_defaults:
    community.general.proxmox: "{{ proxmox_cred | combine({'timeout': 120}, recursive=True) }}"
    community.general.proxmox_vm_info: "{{ proxmox_cred }}"
    uri:
      return_content: yes
      validate_certs: no
